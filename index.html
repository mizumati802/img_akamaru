<!DOCTYPE html>
<html>

<head>
  <title>画像編集ツール</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    .toolbar {
      position: fixed;
      top: 0;
      width: 100%;
      background: #f8f9fa;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      flex-wrap: wrap;
      box-sizing: border-box;
      gap: 10px; /* ボタン間のスペースを設定 */
    }

    .toolbar label,
    .toolbar button {
      flex: 1; /* 各要素が均等にスペースを占める */
      min-width: 100px; /* ボタンの最小幅を設定 */
      text-align: center;
      padding: 10px;
      font-size: 18pt;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .toolbar label {
      background-color: #007bff;
      color: white;
      position: relative;
    }

    .toolbar label input[type="file"] {
      display: inline-block;
      width: 100%;
      height: 100%;
      opacity: 0;
      position: absolute;
      left: 0;
      top: 0;
      cursor: pointer;
    }

    .toolbar button {
      background-color: #28a745;
      color: white;
    }

    .toolbar button.clear-button {
      background-color: #dc3545; /* クリアボタンは赤色 */
    }

    #canvas {
      display: block;
      border: 1px solid #ccc;
      touch-action: none;
      margin-top: 80px; /* ツールバーの高さ分のマージン */
      width: 100%;
      height: calc(100vh - 80px - 40px); /* ツールバーと余白を考慮した高さ */
      box-sizing: border-box;
    }

    #saved-images {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }

    #saved-images img {
      margin-bottom: 20px;
      border: 2px solid #007bff;
      border-radius: 5px;
      max-width: 90%;
      height: auto;
    }

    .responsive-image {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <label for="upload">アップ<input type="file" id="upload" accept="image/*"></label>
    <button onclick="saveCanvas()">保存</button>
    <button class="clear-button" onclick="clearSavedImages()">クリア</button> <!-- クリアボタンの追加 -->
  </div>
  <canvas id="canvas"></canvas>
  <div id="saved-images"></div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let img = new Image();
    let scale = 1;
    let imgWidth, imgHeight;
    let circle = { x: canvas.width / 2, y: canvas.height / 2, radius: 75 }; // 赤丸の初期位置を中心に設定
    let dragging = false;

    function handleImageLoad() {
      const ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
      imgWidth = img.width * ratio;
      imgHeight = img.height * ratio;
      scale = ratio;
      circle.x = canvas.width / 2;
      circle.y = canvas.height / 2;
      drawCanvas();
    }

    img.onload = handleImageLoad;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight - document.querySelector('.toolbar').offsetHeight;
      if (img.src) {
        const ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
        imgWidth = img.width * ratio;
        imgHeight = img.height * ratio;
        scale = ratio;
        circle.x = canvas.width / 2;
        circle.y = canvas.height / 2;
        drawCanvas();
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        circle.x = canvas.width / 2;
        circle.y = canvas.height / 2;
      }
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    document.getElementById("upload").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          img = new Image();
          img.onload = handleImageLoad;
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (img.src) {
        ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
      }
      drawCircle();
    }

    function drawCircle() {
      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
      ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
      ctx.lineWidth = 10;
      ctx.stroke();
    }

    canvas.addEventListener("touchstart", startDrag);
    canvas.addEventListener("touchmove", dragCircle);
    canvas.addEventListener("touchend", endDrag);
    canvas.addEventListener("mousedown", startDrag);
    canvas.addEventListener("mousemove", dragCircle);
    canvas.addEventListener("mouseup", endDrag);

    function startDrag(e) {
      const pos = getMousePos(e);
      const dx = pos.x - circle.x;
      const dy = pos.y - circle.y;
      if (Math.sqrt(dx * dx + dy * dy) <= circle.radius) {
        dragging = true;
      }
    }

    function dragCircle(e) {
      if (dragging) {
        const pos = getMousePos(e);
        circle.x = pos.x;
        circle.y = pos.y;
        drawCanvas();
      }
    }

    function endDrag() {
      dragging = false;
    }

    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    function saveCanvas() {
      if (!img.src) {
        alert("画像をアップロードしてください。");
        return;
      }

      const finalCanvas = document.createElement("canvas");
      const finalCtx = finalCanvas.getContext("2d");

      finalCanvas.width = img.width;
      finalCanvas.height = img.height;

      finalCtx.drawImage(img, 0, 0, img.width, img.height);

      const circleX = circle.x / scale;
      const circleY = circle.y / scale;
      const circleRadius = circle.radius / scale;

      finalCtx.beginPath();
      finalCtx.arc(circleX, circleY, circleRadius, 0, Math.PI * 2);
      finalCtx.strokeStyle = "rgba(255, 0, 0, 0.5)";
      finalCtx.lineWidth = 20;
      finalCtx.stroke();

      const dataURL = finalCanvas.toDataURL("image/jpeg", 0.8);

      // 保存された画像をLocalStorageに追加
      let savedImages = JSON.parse(localStorage.getItem('savedImages')) || [];
      savedImages.push(dataURL);
      localStorage.setItem('savedImages', JSON.stringify(savedImages));

      // 保存画像コンテナに追加
      appendSavedImage(dataURL);

      // キャンバスをリセット
      resetCanvas();
    }

    function appendSavedImage(dataURL) {
      const savedImagesContainer = document.getElementById("saved-images");
      const imgElement = new Image();
      imgElement.src = dataURL;
      imgElement.classList.add("responsive-image");
      savedImagesContainer.prepend(imgElement); // 最新の画像を上に追加
    }

    function resetCanvas() {
      img = new Image();
      img.onload = handleImageLoad; // onloadハンドラーを再設定
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      circle.x = canvas.width / 2;
      circle.y = canvas.height / 2;
      scale = 1;
      imgWidth = 0;
      imgHeight = 0;
      document.getElementById("upload").value = ""; // アップロード入力をリセット
    }

    function loadSavedImages() {
      const savedImages = JSON.parse(localStorage.getItem('savedImages')) || [];
      savedImages.forEach(dataURL => {
        appendSavedImage(dataURL);
      });
    }

    // ページロード時に保存された画像を読み込む
    window.onload = loadSavedImages;

    // クリアボタンの機能
    function clearSavedImages() {
      if (confirm("本当にすべての保存された画像をクリアしますか？")) {
        localStorage.removeItem('savedImages'); // LocalStorageから削除
        const savedImagesContainer = document.getElementById("saved-images");
        savedImagesContainer.innerHTML = ""; // 表示されている画像を削除
        alert("すべての保存された画像がクリアされました。");
      }
    }
  </script>
</body>

</html>