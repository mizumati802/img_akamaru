<!DOCTYPE html>
<html>

<head>
  <title>画像編集ツール</title>
  <style>
    #canvas {
      border: 1px solid #ccc;
      touch-action: none;
    }

    .toolbar {
      position: fixed;
      top: 0;
      width: 100%;
      background: #f8f9fa;
      padding: 10px;
      display: flex;
      justify-content: space-around;
      z-index: 1000;
      flex-wrap: wrap;
      box-sizing: border-box;
    }

    .toolbar label {
      position: relative;
      display: inline-block;
      width: 45%;
      text-align: center;
      padding: 10px;
      font-size: 28pt;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      line-height: 1.5;
      vertical-align: middle;
    }

    .toolbar label input[type="file"] {
      display: inline-block;
      width: 100%;
      height: 100%;
      opacity: 0;
      position: absolute;
      left: 0;
      top: 0;
      cursor: pointer;
    }

    .toolbar button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 45%;
      text-align: center;
      padding: 10px;
      font-size: 28pt;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    #canvas.hidden {
      display: none;
    }

    .responsive-image {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <label for="upload">画像アップロード<input type="file" id="upload" accept="image/*"></label>
    <button onclick="saveCanvas()">保存</button>
  </div>
  <canvas id="canvas"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let img = new Image();
    let scale = 1;
    let imgWidth, imgHeight;
    let circle = { x: 100, y: 100, radius: 75 }; // 赤丸の初期半径を1.5倍に
    let dragging = false;

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - document.querySelector('.toolbar').offsetHeight;

    document.getElementById("upload").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    img.onload = () => {
      const ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
      imgWidth = img.width * ratio;
      imgHeight = img.height * ratio;
      scale = ratio;
      drawCanvas();
    };

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
      drawCircle();
    }

    function drawCircle() {
      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
      ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
      ctx.lineWidth = 10;
      ctx.stroke();
    }

    canvas.addEventListener("touchstart", startDrag);
    canvas.addEventListener("touchmove", dragCircle);
    canvas.addEventListener("touchend", endDrag);
    canvas.addEventListener("mousedown", startDrag);
    canvas.addEventListener("mousemove", dragCircle);
    canvas.addEventListener("mouseup", endDrag);

    function startDrag(e) {
      const pos = getMousePos(e);
      const dx = pos.x - circle.x;
      const dy = pos.y - circle.y;
      if (Math.sqrt(dx * dx + dy * dy) <= circle.radius) {
        dragging = true;
      }
    }

    function dragCircle(e) {
      if (dragging) {
        const pos = getMousePos(e);
        circle.x = pos.x;
        circle.y = pos.y;
        drawCanvas();
      }
    }

    function endDrag() {
      dragging = false;
    }

    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    function saveCanvas() {
      const finalCanvas = document.createElement("canvas");
      const finalCtx = finalCanvas.getContext("2d");

      finalCanvas.width = img.width;
      finalCanvas.height = img.height;

      finalCtx.drawImage(img, 0, 0, img.width, img.height);

      const circleX = circle.x / scale;
      const circleY = circle.y / scale;
      const circleRadius = circle.radius / scale;

      finalCtx.beginPath();
      finalCtx.arc(circleX, circleY, circleRadius, 0, Math.PI * 2);
      finalCtx.strokeStyle = "rgba(255, 0, 0, 0.5)";
      finalCtx.lineWidth = 20;
      finalCtx.stroke();

      canvas.classList.add("hidden");

      const dataURL = finalCanvas.toDataURL("image/jpeg", 0.8);
      const imgElement = new Image();
      imgElement.src = dataURL;
      imgElement.classList.add("responsive-image");
      document.body.appendChild(imgElement);
    }
  </script>
</body>

</html>