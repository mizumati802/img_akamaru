<!DOCTYPE html>
<html>

<head>
  <title>画像編集ツール</title>
  <style>
    #canvas {
      border: 1px solid #ccc;
      touch-action: none;
      /* タッチ操作対応 */
    }

    .toolbar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #f8f9fa;
      padding: 10px;
      display: flex;
      justify-content: space-around;
    }

    .toolbar input[type="file"] {
      display: none;
    }

    #canvas.hidden {
      display: none;
    }

    .responsive-image {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
    }
  </style>
</head>

<body>
  <input type="file" id="upload" accept="image/*">
  <canvas id="canvas"></canvas>
  <div class="toolbar">
    <label for="upload">画像アップロード</label>
    <button onclick="saveCanvas()">保存</button>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let img = new Image();
    let scale = 1; // 縮尺
    let imgWidth, imgHeight;
    let circle = { x: 100, y: 100, radius: 50 }; // 赤丸の初期位置
    let dragging = false;

    // キャンバスサイズを動的に設定
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - 100;

    // 画像アップロード
    document.getElementById("upload").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // 画像の読み込み
    img.onload = () => {
      // 画像の縮尺を計算してキャンバスにフィットさせる
      const ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
      imgWidth = img.width * ratio;
      imgHeight = img.height * ratio;
      scale = ratio;
      drawCanvas();
    };

    // キャンバスに描画
    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
      drawCircle();
    }

    // 赤丸を描画
    function drawCircle() {
      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
      ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
      ctx.lineWidth = 10;
      ctx.stroke();
    }

    // ドラッグで赤丸を移動
    canvas.addEventListener("touchstart", startDrag);
    canvas.addEventListener("touchmove", dragCircle);
    canvas.addEventListener("touchend", endDrag);
    canvas.addEventListener("mousedown", startDrag);
    canvas.addEventListener("mousemove", dragCircle);
    canvas.addEventListener("mouseup", endDrag);

    function startDrag(e) {
      const pos = getMousePos(e);
      const dx = pos.x - circle.x;
      const dy = pos.y - circle.y;
      if (Math.sqrt(dx * dx + dy * dy) <= circle.radius) {
        dragging = true;
      }
    }

    function dragCircle(e) {
      if (dragging) {
        const pos = getMousePos(e);
        circle.x = pos.x;
        circle.y = pos.y;
        drawCanvas();
      }
    }

    function endDrag() {
      dragging = false;
    }

    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    // キャンバスを保存して表示
    function saveCanvas() {
      const finalCanvas = document.createElement("canvas");
      const finalCtx = finalCanvas.getContext("2d");

      // 元画像のサイズに合わせたキャンバスを作成
      finalCanvas.width = img.width;
      finalCanvas.height = img.height;

      // 元画像を描画
      finalCtx.drawImage(img, 0, 0, img.width, img.height);

      // 赤丸を描画（元画像のスケールに合わせて調整）
      const circleX = circle.x / scale;
      const circleY = circle.y / scale;
      const circleRadius = circle.radius / scale;

      finalCtx.beginPath();
      finalCtx.arc(circleX, circleY, circleRadius, 0, Math.PI * 2);
      finalCtx.strokeStyle = "rgba(255, 0, 0, 0.5)";
      finalCtx.lineWidth = 20;
      finalCtx.stroke();

      // 元のキャンバスを非表示にする
      canvas.classList.add("hidden");

      // JPEG画像を表示
      const dataURL = finalCanvas.toDataURL("image/jpeg", 0.8);
      const imgElement = new Image();
      imgElement.src = dataURL;
      imgElement.classList.add("responsive-image");
      document.body.appendChild(imgElement);
    }
  </script>
</body>

</html>
